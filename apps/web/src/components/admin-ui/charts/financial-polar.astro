---
import { cn } from "../utils";

interface Candle {
  label: string;
  open: number;
  high: number;
  low: number;
  close: number;
}

interface Props {
  data?: Candle[];
  class?: string;
  [key: string]: any;
}

const {
  data = [
    { label: "Mon", open: 10, high: 14, low: 8, close: 13 },
    { label: "Tue", open: 13, high: 16, low: 11, close: 12 },
    { label: "Wed", open: 12, high: 17, low: 10, close: 15 },
    { label: "Thu", open: 15, high: 18, low: 14, close: 16 },
    { label: "Fri", open: 16, high: 19, low: 13, close: 14 },
  ],
  class: className,
  ...attrs
} = Astro.props as Props;

const min = Math.min(...data.map((item) => item.low), 0);
const max = Math.max(...data.map((item) => item.high), 1);
const range = Math.max(max - min, 1);

const toY = (value: number) => 100 - ((value - min) / range) * 100;
---

<div data-slot="financial-polar-chart" class={cn("w-full", className)} {...attrs}>
  <svg viewBox="0 0 100 100" class="h-44 w-full" preserveAspectRatio="none">
    {data.map((item, index) => {
      const x = (index + 0.5) * (100 / data.length);
      const bodyWidth = (100 / data.length) * 0.45;
      const openY = toY(item.open);
      const closeY = toY(item.close);
      const highY = toY(item.high);
      const lowY = toY(item.low);
      const top = Math.min(openY, closeY);
      const bodyHeight = Math.max(Math.abs(closeY - openY), 1.2);
      const rise = item.close >= item.open;
      const tone = rise ? "#22c55e" : "#ef4444";

      return (
        <g>
          <line x1={x} y1={highY} x2={x} y2={lowY} stroke={tone} stroke-width="0.7" />
          <rect
            x={x - bodyWidth / 2}
            y={top}
            width={bodyWidth}
            height={bodyHeight}
            fill={tone}
            fill-opacity="0.4"
            stroke={tone}
            stroke-width="0.7"
          />
        </g>
      );
    })}
  </svg>
</div>
