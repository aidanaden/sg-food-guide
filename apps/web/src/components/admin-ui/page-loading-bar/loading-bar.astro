---
import { cn } from "../utils";

interface Props {
  class?: string;
  [key: string]: any;
}

const { class: className, ...attrs } = Astro.props as Props;
---

<div
  data-slot="page-loading-bar"
  data-admin-loading-bar
  class={cn("bg-primary fixed top-0 left-0 z-50 h-0.5 w-0 opacity-0 transition-all duration-150", className)}
  {...attrs}
/>

<script is:inline>
  if (!window.__adminLoadingBarInit) {
    window.__adminLoadingBarInit = true;

    const getBars = () => Array.from(document.querySelectorAll("[data-admin-loading-bar]"));

    const setProgress = (width, visible) => {
      getBars().forEach((bar) => {
        bar.style.width = width;
        bar.style.opacity = visible ? "1" : "0";
      });
    };

    window.addEventListener("admin-loading:start", () => {
      setProgress("20%", true);
      window.setTimeout(() => setProgress("60%", true), 80);
      window.setTimeout(() => setProgress("85%", true), 180);
    });

    window.addEventListener("admin-loading:end", () => {
      setProgress("100%", true);
      window.setTimeout(() => setProgress("100%", false), 140);
      window.setTimeout(() => setProgress("0%", false), 280);
    });
  }
</script>
