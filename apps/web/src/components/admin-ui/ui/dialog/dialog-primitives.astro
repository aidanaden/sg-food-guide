---
import { cn } from "../../utils";
import Button from "../button.astro";

interface Props {
  id?: string;
  class?: string;
  overlayClass?: string;
  contentClass?: string;
  closeOnOverlay?: boolean;
  modal?: boolean;
  showCloseButton?: boolean;
  [key: string]: any;
}

const {
  id,
  class: className,
  overlayClass,
  contentClass,
  closeOnOverlay = true,
  modal = true,
  showCloseButton = true,
  ...attrs
} = Astro.props as Props;

const dialogId = id ?? `admin-dialog-${Math.random().toString(36).slice(2, 10)}`;
---

<div
  id={dialogId}
  data-slot="dialog"
  data-admin-dialog
  data-state="closed"
  data-close-on-overlay={closeOnOverlay ? "true" : "false"}
  data-modal={modal ? "true" : "false"}
  class={cn("relative", className)}
  {...attrs}
>
  <div data-slot="dialog-trigger" data-admin-dialog-trigger>
    <slot name="trigger" />
  </div>

  <div
    data-slot="dialog-overlay"
    data-admin-dialog-overlay
    class={cn(
      "fixed inset-0 z-50 hidden items-center justify-center bg-black/30 p-4 opacity-0 backdrop-blur-sm transition-opacity duration-150",
      overlayClass,
    )}
  >
    <div
      data-slot="dialog-content"
      data-admin-dialog-content
      role="dialog"
      aria-modal={modal ? "true" : "false"}
      tabindex="-1"
      class={cn(
        "bg-background ring-border text-foreground relative w-full max-w-lg rounded-xl p-4 shadow-lg ring-1 transition-all duration-150",
        "translate-y-2 opacity-0",
        contentClass,
      )}
    >
      {showCloseButton && (
        <Button data-admin-dialog-close variant="ghost" size="icon-sm" class="absolute top-2 right-2">
          <span aria-hidden="true" class="iconify ph--x size-4" />
          <span class="sr-only">Close</span>
        </Button>
      )}

      {Astro.slots.has("header") && (
        <div data-slot="dialog-header" class="mb-3 flex flex-col gap-1">
          <slot name="header" />
        </div>
      )}

      <slot />

      {Astro.slots.has("footer") && (
        <div data-slot="dialog-footer" class="mt-4 flex flex-col-reverse gap-2 sm:flex-row sm:justify-end">
          <slot name="footer" />
        </div>
      )}
    </div>
  </div>
</div>

<script is:inline>
  const roots = document.querySelectorAll("[data-admin-dialog]");

  roots.forEach((root) => {
    if (root.__adminDialogInit) {
      return;
    }
    root.__adminDialogInit = true;

    const overlay = root.querySelector("[data-admin-dialog-overlay]");
    const content = root.querySelector("[data-admin-dialog-content]");
    const triggerHost = root.querySelector("[data-admin-dialog-trigger]");
    if (overlay == null || content == null) {
      return;
    }

    const isModal = root.dataset.modal === "true";
    const closeOnOverlay = root.dataset.closeOnOverlay === "true";

    const setOpen = (open) => {
      root.dataset.state = open ? "open" : "closed";

      if (open) {
        overlay.classList.remove("hidden", "opacity-0");
        overlay.classList.add("flex", "opacity-100");
        content.classList.remove("translate-y-2", "opacity-0");
        content.classList.add("translate-y-0", "opacity-100");

        if (isModal) {
          document.body.classList.add("overflow-hidden");
        }

        window.setTimeout(() => content.focus(), 0);
        root.dispatchEvent(new CustomEvent("dialog:open", { bubbles: true, detail: { id: root.id } }));
        return;
      }

      overlay.classList.remove("opacity-100");
      overlay.classList.add("opacity-0");
      content.classList.remove("translate-y-0", "opacity-100");
      content.classList.add("translate-y-2", "opacity-0");

      window.setTimeout(() => {
        overlay.classList.remove("flex");
        overlay.classList.add("hidden");
      }, 150);

      if (isModal) {
        document.body.classList.remove("overflow-hidden");
      }

      root.dispatchEvent(new CustomEvent("dialog:close", { bubbles: true, detail: { id: root.id } }));
    };

    root.querySelectorAll("[data-admin-dialog-open]").forEach((el) => {
      el.addEventListener("click", (event) => {
        if (event.currentTarget instanceof HTMLAnchorElement) {
          event.preventDefault();
        }
        setOpen(true);
      });
    });

    root.querySelectorAll("[data-admin-dialog-close]").forEach((el) => {
      el.addEventListener("click", () => setOpen(false));
    });

    if (triggerHost != null) {
      triggerHost.addEventListener("click", (event) => {
        const target = event.target;
        if (!(target instanceof Element)) {
          return;
        }

        if (target.closest("[data-admin-dialog-close]")) {
          return;
        }

        if (target.closest("a") instanceof HTMLAnchorElement) {
          event.preventDefault();
        }

        setOpen(true);
      });
    }

    overlay.addEventListener("click", (event) => {
      if (!closeOnOverlay) {
        return;
      }

      if (event.target === overlay) {
        setOpen(false);
      }
    });

    document.addEventListener("keydown", (event) => {
      if (event.key !== "Escape") {
        return;
      }
      if (root.dataset.state !== "open") {
        return;
      }
      setOpen(false);
    });

    root.addEventListener("dialog:set", (event) => {
      const detail = event.detail ?? {};
      setOpen(detail.open === true);
    });
  });
</script>
