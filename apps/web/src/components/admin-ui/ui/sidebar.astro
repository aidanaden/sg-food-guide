---
import { cn } from "../utils";
import Button from "./button.astro";

interface Props {
  id?: string;
  side?: "left" | "right";
  variant?: "sidebar" | "floating" | "inset";
  collapsible?: "offcanvas" | "icon" | "none";
  defaultOpen?: boolean;
  class?: string;
  sidebarClass?: string;
  insetClass?: string;
  [key: string]: any;
}

const {
  id,
  side = "left",
  variant = "sidebar",
  collapsible = "offcanvas",
  defaultOpen = true,
  class: className,
  sidebarClass,
  insetClass,
  ...attrs
} = Astro.props as Props;

const sidebarId = id ?? `admin-sidebar-${Math.random().toString(36).slice(2, 10)}`;
const initialState = defaultOpen || collapsible === "none" ? "expanded" : "collapsed";

const borderSideClass = side === "left" ? "border-r" : "border-l";
---

<div
  id={sidebarId}
  data-slot="sidebar-wrapper"
  data-admin-sidebar
  data-state={initialState}
  data-side={side}
  data-variant={variant}
  data-collapsible={collapsible}
  data-mobile-open="false"
  class={cn("relative min-h-screen w-full", className)}
  {...attrs}
>
  <div class="absolute top-2 z-30 md:top-3" class:list={[side === "left" ? "left-2" : "right-2"]}>
    <Button data-admin-sidebar-trigger variant="ghost" size="icon-sm" class="size-7">
      <slot name="trigger">
        <span aria-hidden="true" class="iconify ph--sidebar-simple size-4" />
        <span class="sr-only">Toggle Sidebar</span>
      </slot>
    </Button>
  </div>

  <div class={cn("flex min-h-screen w-full", side === "right" ? "flex-row-reverse" : "flex-row")}>
    <aside
      data-slot="sidebar"
      data-admin-sidebar-desktop
      class={cn(
        "bg-surface text-foreground border-border hidden shrink-0 flex-col overflow-hidden transition-all duration-200 md:flex",
        variant === "floating" ? "m-2 rounded-lg border shadow-sm" : undefined,
        variant === "sidebar" ? borderSideClass : undefined,
        sidebarClass,
      )}
    >
      <slot />
    </aside>

    <main
      data-slot="sidebar-inset"
      class={cn(
        "bg-background min-w-0 flex-1",
        variant === "inset" ? "md:m-2 md:rounded-lg md:shadow-sm" : undefined,
        insetClass,
      )}
    >
      <slot name="inset" />
    </main>
  </div>

  <div data-slot="sidebar-backdrop" data-admin-sidebar-backdrop class="fixed inset-0 z-40 hidden bg-black/40 md:hidden" />

  <aside
    data-slot="sidebar-mobile"
    data-admin-sidebar-mobile
    class={cn(
      "bg-surface text-foreground fixed top-0 z-50 hidden h-screen w-72 max-w-full flex-col overflow-auto p-3 shadow-lg transition-transform duration-200 md:hidden",
      side === "left" ? "left-0 -translate-x-full" : "right-0 translate-x-full",
      sidebarClass,
    )}
  >
    <div class="mb-2 flex items-center justify-end">
      <Button data-admin-sidebar-close variant="ghost" size="icon-sm">
        <span aria-hidden="true" class="iconify ph--x size-4" />
        <span class="sr-only">Close sidebar</span>
      </Button>
    </div>
    <slot />
  </aside>
</div>

<script is:inline>
  const roots = document.querySelectorAll("[data-admin-sidebar]");

  roots.forEach((root) => {
    if (root.__adminSidebarInit) {
      return;
    }
    root.__adminSidebarInit = true;

    const desktop = root.querySelector("[data-admin-sidebar-desktop]");
    const mobile = root.querySelector("[data-admin-sidebar-mobile]");
    const backdrop = root.querySelector("[data-admin-sidebar-backdrop]");
    const side = root.dataset.side ?? "left";
    const collapsible = root.dataset.collapsible ?? "offcanvas";
    const storageKey = `${root.id || "admin-sidebar"}:state`;

    try {
      const persistedState = window.localStorage.getItem(storageKey);
      if (persistedState === "expanded" || persistedState === "collapsed") {
        root.dataset.state = persistedState;
      }
    } catch {
      // Ignore storage errors.
    }

    const applyDesktopState = () => {
      if (!(desktop instanceof HTMLElement)) {
        return;
      }

      const state = root.dataset.state ?? "expanded";
      desktop.classList.remove("w-64", "w-12", "w-0", "-translate-x-full", "translate-x-full");

      if (collapsible === "none") {
        desktop.classList.add("w-64");
        return;
      }

      if (state === "expanded") {
        desktop.classList.add("w-64");
        return;
      }

      if (collapsible === "icon") {
        desktop.classList.add("w-12");
        return;
      }

      desktop.classList.add("w-0");
      desktop.classList.add(side === "left" ? "-translate-x-full" : "translate-x-full");
    };

    const applyMobileState = () => {
      if (!(mobile instanceof HTMLElement) || !(backdrop instanceof HTMLElement)) {
        return;
      }

      const mobileOpen = root.dataset.mobileOpen === "true";
      backdrop.classList.toggle("hidden", !mobileOpen);

      if (mobileOpen) {
        mobile.classList.remove("hidden");
        mobile.classList.remove(side === "left" ? "-translate-x-full" : "translate-x-full");
        document.body.classList.add("overflow-hidden");
        return;
      }

      mobile.classList.add(side === "left" ? "-translate-x-full" : "translate-x-full");
      window.setTimeout(() => {
        if (root.dataset.mobileOpen !== "true") {
          mobile.classList.add("hidden");
        }
      }, 150);
      document.body.classList.remove("overflow-hidden");
    };

    const toggleDesktop = () => {
      if (collapsible === "none") {
        return;
      }

      const nextState = root.dataset.state === "expanded" ? "collapsed" : "expanded";
      root.dataset.state = nextState;
      applyDesktopState();

      try {
        window.localStorage.setItem(storageKey, nextState);
      } catch {
        // Ignore storage errors.
      }

      root.dispatchEvent(
        new CustomEvent("sidebar:toggle", {
          bubbles: true,
          detail: { state: nextState },
        }),
      );
    };

    const openMobile = () => {
      root.dataset.mobileOpen = "true";
      applyMobileState();
      root.dispatchEvent(new CustomEvent("sidebar:open-mobile", { bubbles: true }));
    };

    const closeMobile = () => {
      root.dataset.mobileOpen = "false";
      applyMobileState();
      root.dispatchEvent(new CustomEvent("sidebar:close-mobile", { bubbles: true }));
    };

    root.querySelectorAll("[data-admin-sidebar-trigger]").forEach((trigger) => {
      trigger.addEventListener("click", () => {
        const mobileQuery = window.matchMedia("(max-width: 767px)");
        if (mobileQuery.matches) {
          openMobile();
          return;
        }
        toggleDesktop();
      });
    });

    root.querySelectorAll("[data-admin-sidebar-close]").forEach((closeButton) => {
      closeButton.addEventListener("click", closeMobile);
    });

    backdrop?.addEventListener("click", closeMobile);

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape" && root.dataset.mobileOpen === "true") {
        closeMobile();
      }

      if ((event.metaKey || event.ctrlKey) && event.key.toLowerCase() === "b") {
        event.preventDefault();
        const mobileQuery = window.matchMedia("(max-width: 767px)");
        if (mobileQuery.matches) {
          openMobile();
          return;
        }
        toggleDesktop();
      }
    });

    applyDesktopState();
    applyMobileState();
  });
</script>
