---
import { cn } from "../utils";

interface DropdownItem {
  label: string;
  value?: string;
  href?: string;
  disabled?: boolean;
  destructive?: boolean;
}

interface Props {
  label?: string;
  items?: DropdownItem[];
  class?: string;
  triggerClass?: string;
  contentClass?: string;
  align?: "start" | "end";
  [key: string]: any;
}

const {
  label = "Menu",
  items = [],
  class: className,
  triggerClass,
  contentClass,
  align = "start",
  ...attrs
} = Astro.props as Props;

const alignClass = align === "end" ? "right-0" : "left-0";
const hasItems = items.length > 0;
---

<details data-slot="dropdown-menu" data-admin-dropdown class={cn("relative inline-block", className)} {...attrs}>
  <summary
    data-slot="dropdown-menu-trigger"
    class={cn(
      "inline-flex list-none cursor-pointer items-center gap-1 rounded-md border px-2 py-1 text-sm",
      triggerClass,
    )}
  >
    <slot name="trigger">{label}</slot>
    <span aria-hidden="true" class="iconify ph--caret-down text-xs" />
  </summary>

  <div
    data-slot="dropdown-menu-content"
    class={cn(
      "bg-surface-overlay ring-border text-foreground absolute z-50 mt-2 min-w-36 rounded-lg p-1 shadow-md ring-1",
      alignClass,
      contentClass,
    )}
  >
    {hasItems ? (
      <ul class="space-y-0.5">
        {items.map((item) => (
          <li>
            {item.href != null ? (
              <a
                href={item.href}
                data-dropdown-value={item.value ?? item.label}
                class={cn(
                  "block rounded-md px-2.5 py-1.5 text-sm",
                  item.destructive ? "text-destructive hover:bg-destructive/10" : "hover:bg-muted",
                  item.disabled ? "pointer-events-none opacity-50" : undefined,
                )}
              >
                {item.label}
              </a>
            ) : (
              <button
                type="button"
                data-dropdown-value={item.value ?? item.label}
                disabled={item.disabled}
                class={cn(
                  "w-full rounded-md px-2.5 py-1.5 text-left text-sm",
                  item.destructive ? "text-destructive hover:bg-destructive/10" : "hover:bg-muted",
                  item.disabled ? "pointer-events-none opacity-50" : undefined,
                )}
              >
                {item.label}
              </button>
            )}
          </li>
        ))}
      </ul>
    ) : (
      <slot />
    )}
  </div>
</details>

<style>
  details[data-admin-dropdown] > summary {
    list-style: none;
  }

  details[data-admin-dropdown] > summary::-webkit-details-marker {
    display: none;
  }
</style>

<script is:inline>
  if (!window.__adminDropdownInit) {
    window.__adminDropdownInit = true;

    document.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof Element)) {
        return;
      }

      document.querySelectorAll("details[data-admin-dropdown][open]").forEach((menu) => {
        if (!menu.contains(target)) {
          menu.removeAttribute("open");
        }
      });

      const action = target.closest("[data-dropdown-value]");
      if (action == null) {
        return;
      }

      const root = action.closest("details[data-admin-dropdown]");
      if (root == null) {
        return;
      }

      root.dispatchEvent(
        new CustomEvent("dropdown-menu:select", {
          bubbles: true,
          detail: {
            value: action.getAttribute("data-dropdown-value") ?? "",
          },
        }),
      );

      root.removeAttribute("open");
    });
  }
</script>
