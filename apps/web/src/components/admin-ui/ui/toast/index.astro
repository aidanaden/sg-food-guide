---
import type { HTMLAttributes } from "astro/types";
import { cn } from "../../utils";

interface Props extends HTMLAttributes<"div"> {
  position?:
    | "top-center"
    | "top-right"
    | "top-left"
    | "bottom-center"
    | "bottom-right"
    | "bottom-left";
}

const { position = "top-center", class: className, ...attrs } = Astro.props as Props;

const positionClasses = {
  "top-center": "top-2 left-1/2 -translate-x-1/2",
  "top-right": "top-2 right-2",
  "top-left": "top-2 left-2",
  "bottom-center": "bottom-2 left-1/2 -translate-x-1/2",
  "bottom-right": "bottom-2 right-2",
  "bottom-left": "bottom-2 left-2",
} as const;
---

<div
  data-slot="toast-viewport"
  data-admin-toast-host
  class={cn(
    "pointer-events-none fixed z-50 flex w-full max-w-sm flex-col gap-2",
    positionClasses[position],
    className,
  )}
  {...attrs}
/>

<script is:inline>
  if (!window.__toastInit) {
    window.__toastInit = true;

    const DEFAULT_DURATION = 5000;
    const LOADING_DURATION = 30000;

    const getHosts = () => Array.from(document.querySelectorAll("[data-admin-toast-host]"));

    const iconClassMap = {
      success: "ph--check-circle-fill text-success-text",
      error: "ph--x-circle-fill text-destructive-text",
      info: "ph--info-fill text-primary",
      loading: "ph--spinner-bold animate-spin text-foreground-muted",
    };

    const safeId = (id) => {
      if (typeof id === "number" || typeof id === "string") {
        return String(id);
      }
      return `${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
    };

    const dismiss = (id) => {
      const targetId = String(id);
      document.querySelectorAll(`[data-toast-id=\"${targetId}\"]`).forEach((el) => {
        if (!(el instanceof HTMLElement)) {
          return;
        }
        el.style.opacity = "0";
        el.style.transform = "translateY(-0.25rem)";
        window.setTimeout(() => el.remove(), 140);
      });
    };

    const createToastNode = ({ id, type, title, description }) => {
      const wrapper = document.createElement("div");
      wrapper.setAttribute("data-toast-id", id);
      wrapper.setAttribute("data-toast-type", type);
      wrapper.className =
        "bg-surface text-foreground ring-border pointer-events-auto flex w-full items-start gap-2 rounded-lg p-3 text-sm shadow ring-1 transition-all duration-150";

      const icon = document.createElement("span");
      icon.setAttribute("aria-hidden", "true");
      icon.className = `iconify mt-0.5 size-4 shrink-0 ${iconClassMap[type] ?? iconClassMap.info}`;

      const content = document.createElement("div");
      content.className = "min-w-0 flex-1";

      const titleEl = document.createElement("div");
      titleEl.className = "text-sm font-medium";
      titleEl.textContent = title;
      content.appendChild(titleEl);

      if (description != null && String(description).length > 0) {
        const descriptionEl = document.createElement("div");
        descriptionEl.className = "text-foreground-muted mt-0.5 text-sm";
        descriptionEl.textContent = String(description);
        content.appendChild(descriptionEl);
      }

      wrapper.appendChild(icon);
      wrapper.appendChild(content);

      if (type !== "loading") {
        const close = document.createElement("button");
        close.type = "button";
        close.setAttribute("aria-label", "Close");
        close.className =
          "hover:bg-muted ml-auto inline-flex size-6 shrink-0 items-center justify-center rounded-full";
        close.innerHTML =
          '<span aria-hidden="true" class="iconify ph--x-bold text-foreground-muted size-3"></span>';
        close.addEventListener("click", (event) => {
          event.preventDefault();
          event.stopPropagation();
          dismiss(id);
        });
        wrapper.appendChild(close);
      }

      return wrapper;
    };

    const pushToast = ({ id, type = "info", title, description, duration }) => {
      const toastId = safeId(id);
      const toastDuration =
        typeof duration === "number"
          ? duration
          : type === "loading"
            ? LOADING_DURATION
            : DEFAULT_DURATION;

      getHosts().forEach((host) => {
        host.appendChild(createToastNode({ id: toastId, type, title, description }));
      });

      if (type !== "loading" && toastDuration > 0) {
        window.setTimeout(() => dismiss(toastId), toastDuration);
      }

      return toastId;
    };

    window.toast = {
      success: ({ id, title, description, duration } = {}) =>
        pushToast({ id, type: "success", title: String(title ?? "Success"), description, duration }),
      error: ({ id, title, description, duration } = {}) =>
        pushToast({ id, type: "error", title: String(title ?? "Error"), description, duration }),
      info: ({ id, title, description, duration } = {}) =>
        pushToast({ id, type: "info", title: String(title ?? "Info"), description, duration }),
      loading: ({ id, title, description, duration } = {}) =>
        pushToast({ id, type: "loading", title: String(title ?? "Loading"), description, duration }),
      dismiss,
    };

    window.addEventListener("toast:success", (event) => {
      window.toast.success(event.detail ?? {});
    });

    window.addEventListener("toast:error", (event) => {
      window.toast.error(event.detail ?? {});
    });

    window.addEventListener("toast:info", (event) => {
      window.toast.info(event.detail ?? {});
    });

    window.addEventListener("toast:loading", (event) => {
      window.toast.loading(event.detail ?? {});
    });

    window.addEventListener("toast:dismiss", (event) => {
      const detail = event.detail ?? {};
      if (detail.id != null) {
        window.toast.dismiss(detail.id);
      }
    });
  }
</script>
