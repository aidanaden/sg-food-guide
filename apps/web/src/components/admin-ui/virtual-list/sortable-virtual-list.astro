---
import { cn } from "../utils";

interface Props {
  items?: any[];
  class?: string;
  itemClass?: string;
  emptyText?: string;
  [key: string]: any;
}

const {
  items = [],
  class: className,
  itemClass,
  emptyText = "No items",
  ...attrs
} = Astro.props as Props;

const id = `admin-sortable-list-${Math.random().toString(36).slice(2, 10)}`;
---

<div id={id} data-slot="sortable-virtual-list" class={cn("overflow-auto", className)} {...attrs}>
  {items.length === 0 ? (
    <div class="text-foreground-muted px-3 py-4 text-sm">{emptyText}</div>
  ) : (
    <ul class="divide-border divide-y" data-sortable-list>
      {items.map((item, index) => (
        <li class={cn("flex items-start gap-2 px-3 py-2", itemClass)} data-index={index}>
          <span class="text-foreground-muted mt-1 text-xs" aria-hidden="true">#{index + 1}</span>
          <div class="min-w-0 flex-1">
            <pre class="overflow-auto text-xs">{JSON.stringify(item, null, 2)}</pre>
          </div>
          <div class="flex items-center gap-1">
            <button type="button" data-move="up" class="rounded border px-1.5 py-0.5 text-xs">↑</button>
            <button type="button" data-move="down" class="rounded border px-1.5 py-0.5 text-xs">↓</button>
          </div>
        </li>
      ))}
    </ul>
  )}
</div>

<script is:inline define:vars={{ id }}>
  const root = document.getElementById(id);
  if (root != null) {
    root.addEventListener("click", (event) => {
      const target = event.target;
      if (!(target instanceof Element)) {
        return;
      }

      const button = target.closest("button[data-move]");
      if (button == null) {
        return;
      }

      const item = button.closest("li[data-index]");
      const list = root.querySelector("[data-sortable-list]");
      if (item == null || list == null) {
        return;
      }

      const move = button.getAttribute("data-move");
      if (move === "up" && item.previousElementSibling != null) {
        list.insertBefore(item, item.previousElementSibling);
      }

      if (move === "down" && item.nextElementSibling != null) {
        list.insertBefore(item.nextElementSibling, item);
      }

      Array.from(list.children).forEach((node, index) => {
        node.setAttribute("data-index", String(index));
        const indexLabel = node.querySelector("span[aria-hidden='true']");
        if (indexLabel != null) {
          indexLabel.textContent = `#${index + 1}`;
        }
      });

      root.dispatchEvent(new CustomEvent("sortable-virtual-list:reorder", { bubbles: true }));
    });
  }
</script>
