---
interface Props {
  id: string;
  class?: string;
  overlayClass?: string;
  panelClass?: string;
  closeOnOverlay?: boolean;
  modal?: boolean;
  showOverlay?: boolean;
  showHandle?: boolean;
  [key: string]: any;
}

const {
  id,
  class: className,
  overlayClass,
  panelClass,
  closeOnOverlay = true,
  modal = true,
  showOverlay = true,
  showHandle = true,
  ...rest
} = Astro.props;
---

<div
  id={id}
  class:list={['relative', className]}
  data-responsive-dialog
  data-state="closed"
  data-close-on-overlay={closeOnOverlay ? 'true' : 'false'}
  data-modal={modal ? 'true' : 'false'}
  {...rest}
>
  <div data-rd-trigger>
    <slot name="trigger" />
  </div>

  <div
    data-rd-overlay
    class:list={[
      'fixed inset-0 z-50 hidden opacity-0 transition-opacity duration-200 ease-out',
      showOverlay ? 'bg-warm-950/70 backdrop-blur-sm' : 'bg-transparent',
      !modal && 'pointer-events-none',
      overlayClass,
    ]}
  >
    <div class="flex min-h-full items-end justify-center px-3 sm:items-center sm:p-4">
      <div
        data-rd-panel
        role="dialog"
        aria-modal={modal ? 'true' : 'false'}
        tabindex="-1"
        class:list={[
          'pointer-events-auto w-full max-h-[85vh] overflow-hidden rounded-t-2xl border-t border-warm-700 bg-surface shadow-2xl transition-all duration-200 ease-out will-change-transform transform-gpu',
          'translate-y-8 opacity-0 sm:translate-y-6 sm:scale-95 sm:max-h-[80vh] sm:max-w-6xl sm:rounded-xl sm:border',
          panelClass,
        ]}
      >
        {showHandle && (
          <div class="flex justify-center pt-2 sm:hidden">
            <span class="h-1.5 w-10 rounded-full bg-warm-600/80" aria-hidden="true" />
          </div>
        )}
        <slot />
      </div>
    </div>
  </div>
</div>

<script>
  const roots = document.querySelectorAll<HTMLElement>('[data-responsive-dialog]');

  roots.forEach((root) => {
    if ((root as HTMLElement & { __rdInit?: boolean }).__rdInit) return;
    (root as HTMLElement & { __rdInit?: boolean }).__rdInit = true;

    const overlay = root.querySelector<HTMLElement>('[data-rd-overlay]');
    const panel = root.querySelector<HTMLElement>('[data-rd-panel]');
    if (!overlay || !panel) return;

    const isModal = root.dataset.modal === 'true';
    const closeOnOverlay = root.dataset.closeOnOverlay === 'true';
    let closeTimer: number | null = null;
    let openTimer: number | null = null;

    const ANIMATION_MS = 200;

    const clearTimers = () => {
      if (closeTimer) {
        clearTimeout(closeTimer);
        closeTimer = null;
      }
      if (openTimer) {
        clearTimeout(openTimer);
        openTimer = null;
      }
    };

    const setOpen = (open: boolean) => {
      clearTimers();

      if (open) {
        root.dataset.state = 'opening';
        overlay.classList.remove('hidden');

        // Use double RAF so browsers commit initial hidden/offscreen styles before animating in.
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            overlay.classList.remove('opacity-0');
            overlay.classList.add('opacity-100');
            panel.classList.remove('translate-y-8', 'opacity-0', 'sm:translate-y-6', 'sm:scale-95');
            panel.classList.add('translate-y-0', 'opacity-100', 'sm:translate-y-0', 'sm:scale-100');
          });
        });

        if (isModal) {
          document.body.classList.add('overflow-hidden');
        }

        openTimer = window.setTimeout(() => {
          root.dataset.state = 'open';
          panel.focus();
        }, ANIMATION_MS);

        root.dispatchEvent(
          new CustomEvent('responsive-dialog:open', {
            bubbles: true,
            detail: { id: root.id },
          }),
        );
        return;
      }

      root.dataset.state = 'closing';
      overlay.classList.remove('opacity-100');
      overlay.classList.add('opacity-0');
      panel.classList.remove('translate-y-0', 'opacity-100', 'sm:translate-y-0', 'sm:scale-100');
      panel.classList.add('translate-y-8', 'opacity-0', 'sm:translate-y-6', 'sm:scale-95');

      closeTimer = window.setTimeout(() => {
        overlay.classList.add('hidden');
        root.dataset.state = 'closed';
        if (isModal) {
          document.body.classList.remove('overflow-hidden');
        }
      }, ANIMATION_MS);

      root.dispatchEvent(
        new CustomEvent('responsive-dialog:close', {
          bubbles: true,
          detail: { id: root.id },
        }),
      );
    };

    root.querySelectorAll<HTMLElement>('[data-rd-open]').forEach((el) => {
      el.addEventListener('click', (event) => {
        if (event.currentTarget instanceof HTMLAnchorElement) event.preventDefault();
        setOpen(true);
      });
    });

    root.querySelectorAll<HTMLElement>('[data-rd-close]').forEach((el) => {
      el.addEventListener('click', () => setOpen(false));
    });

    overlay.addEventListener('click', (event) => {
      if (!closeOnOverlay) return;
      if (event.target === overlay) setOpen(false);
    });

    document.addEventListener('keydown', (event) => {
      if (event.key !== 'Escape') return;
      if (root.dataset.state !== 'open') return;
      setOpen(false);
    });
  });
</script>
