---
import Layout from '../../layouts/Layout.astro';
import Badge from '../../components/ui/Badge.astro';
import Button from '../../components/ui/Button.astro';
import {
  stalls,
  getRatingLabel,
  getRatingVariant,
  getGoogleMapsUrl,
  getYouTubeSearchUrl,
  getYouTubeEmbedUrl,
  normalizeYouTubeVideoId,
  getStallArea,
  timeCategoryLabels,
  timeCategoryIcons,
} from '../../data/stalls';

export function getStaticPaths() {
  return stalls.map((stall) => ({
    params: { slug: stall.slug },
    props: { stall },
  }));
}

const { stall } = Astro.props;
const area = getStallArea(stall);
const mapsUrl = getGoogleMapsUrl(stall.googleMapsName, stall.address);
const youtubeQuery = stall.youtubeTitle || `${stall.name} review`;
const youtubeUrl = getYouTubeSearchUrl(youtubeQuery);
const youtubeVideoId = normalizeYouTubeVideoId(stall.youtubeVideoId);
const youtubeEmbedUrl = youtubeVideoId ? getYouTubeEmbedUrl(youtubeVideoId) : null;
const hasYouTubeSection = Boolean(stall.youtubeTitle || stall.youtubeVideoId);
const normalizedRating = stall.ratingModerated === null ? null : Math.min(Math.max(stall.ratingModerated, 0), 3);
const normalizedOriginalRating = stall.ratingOriginal === null ? null : Math.min(Math.max(stall.ratingOriginal, 0), 3);
const ratingLabel = getRatingLabel(normalizedRating);
const ratingVariant = getRatingVariant(normalizedRating);

// Google Maps embed URL (search mode, no API key needed)
const mapsEmbedQuery = encodeURIComponent(`${stall.googleMapsName} ${stall.address}`);
const mapsSearchEmbedUrl = `https://maps.google.com/maps?q=${mapsEmbedQuery}&output=embed`;

---

<Layout title={`${stall.name} — SG Food Guide`} description={`${stall.name} review: ${stall.dishName} at $${stall.price}.${normalizedRating !== null ? ` Rated ${normalizedRating}/3 (${ratingLabel}).` : ''} ${area}.`} ogType="article" canonicalPath={`/stall/${stall.slug}`}>
  <script type="application/ld+json" is:inline set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Restaurant",
    "name": stall.name,
    "servesCuisine": stall.cuisineLabel,
    "address": {
      "@type": "PostalAddress",
      "streetAddress": stall.address,
      "addressCountry": stall.country,
    },
    ...(stall.lat && stall.lng ? {
      "geo": {
        "@type": "GeoCoordinates",
        "latitude": stall.lat,
        "longitude": stall.lng,
      }
    } : {}),
    "priceRange": `$${stall.price.toFixed(0)}`,
    ...(normalizedRating !== null ? {
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": normalizedRating,
        "bestRating": 3,
        "worstRating": 1,
        "ratingCount": 1,
      }
    } : {}),
  })} />
  <div class="min-h-screen">
    <!-- Back nav -->
    <nav class="border-b border-warm-800/40">
      <div class="mx-auto max-w-3xl px-4 py-3 flex items-center gap-4">
        <a href="/" class="inline-flex items-center gap-1.5 text-sm text-ink-muted hover:text-flame-400 transition-colors group py-2">
          <span class="i-ph-arrow-left text-sm group-hover:-translate-x-0.5 transition-transform" />
          All stalls
        </a>
        <a href={`/cuisine/${stall.cuisine}`} class="inline-flex items-center gap-1.5 text-sm text-ink-faint hover:text-flame-400 transition-colors py-2">
          <span class="i-ph-bowl-food text-xs" />
          {stall.cuisineLabel}
        </a>
      </div>
    </nav>

    <main class="mx-auto max-w-3xl px-4 py-8 sm:py-12">
      <!-- Awards -->
      {stall.awards.length > 0 && (
        <div class="flex flex-wrap gap-2 mb-5">
          {stall.awards.map((award) => (
            <Badge variant="award" size="md">
              <span class="i-ph-trophy-fill text-xs" />
              {award}
            </Badge>
          ))}
        </div>
      )}

      <!-- Title -->
      <div class="flex items-start gap-3">
        <h1 class="font-display text-3xl sm:text-4xl font-800 tracking-tight leading-tight flex-1">
          {stall.name}
        </h1>
        <button
          type="button"
          id="detail-fav-btn"
          data-slug={stall.slug}
          class="shrink-0 inline-flex h-11 w-11 aspect-square p-0 items-center justify-center rounded-lg border border-warm-700/50 bg-surface-raised hover:border-flame-500/40 transition-colors cursor-pointer"
          aria-label="Toggle favorite"
        >
          <span id="detail-fav-outline" class="i-ph-heart text-xl text-ink-faint" />
          <span id="detail-fav-filled" class="i-ph-heart-fill text-xl text-flame-400 hidden" />
        </button>
      </div>

      <!-- Meta row -->
      <div class="flex flex-wrap items-center gap-x-4 gap-y-2 mt-4">
        <Badge variant={ratingVariant} size="md">
          <span class="font-mono font-bold text-lg">{normalizedRating !== null ? `${normalizedRating}/3` : '—'}</span>
          <span class="text-sm font-medium">{ratingLabel}</span>
        </Badge>
        <span class="font-mono text-2xl font-bold text-flame-400">${stall.price.toFixed(stall.price % 1 ? 1 : 0)}</span>
        {stall.episodeNumber && (
          <span class="text-ink-faint text-sm">Ep. {stall.episodeNumber}</span>
        )}
      </div>

      <!-- Time categories -->
      <div class="flex flex-wrap gap-2 mt-3">
        {stall.timeCategories.map((tc) => (
          <Badge variant="time" size="sm">
            <span class={`${timeCategoryIcons[tc]} text-xs`} />
            {timeCategoryLabels[tc]}
          </Badge>
        ))}
      </div>

      <!-- Info cards -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-8">
        <div class="rounded-xl border border-warm-800/50 bg-surface-card p-4">
          <div class="flex items-center gap-2 mb-2">
            <span class="i-ph-bowl-food text-flame-400" />
            <h3 class="text-xs font-semibold text-ink-faint uppercase tracking-wider">Dish</h3>
          </div>
          <p class="text-ink font-medium">{stall.dishName}</p>
        </div>

        <div class="rounded-xl border border-warm-800/50 bg-surface-card p-4">
          <div class="flex items-center gap-2 mb-2">
            <span class="i-ph-map-trifold text-flame-400" />
            <h3 class="text-xs font-semibold text-ink-faint uppercase tracking-wider">Area</h3>
          </div>
          <p class="text-ink font-medium">{area}</p>
        </div>

        <div class="rounded-xl border border-warm-800/50 bg-surface-card p-4">
          <div class="flex items-center gap-2 mb-2">
            <span class="i-ph-map-pin text-flame-400" />
            <h3 class="text-xs font-semibold text-ink-faint uppercase tracking-wider">Address</h3>
          </div>
          <p class="text-ink font-medium text-sm leading-relaxed break-words">{stall.address}</p>
        </div>

        <div class="rounded-xl border border-warm-800/50 bg-surface-card p-4">
          <div class="flex items-center gap-2 mb-2">
            <span class="i-ph-clock text-flame-400" />
            <h3 class="text-xs font-semibold text-ink-faint uppercase tracking-wider">Opening Times</h3>
          </div>
          <p class="text-ink font-medium text-sm leading-relaxed">{stall.openingTimes}</p>
        </div>
      </div>

      <!-- Hits & Misses -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
        {stall.hits.length > 0 && (
          <div class="rounded-xl border border-jade-500/20 bg-jade-500/5 p-5">
            <div class="flex items-center gap-2 mb-3">
              <span class="i-ph-thumbs-up text-jade-400" />
              <h3 class="text-sm font-semibold text-jade-400">Hits</h3>
            </div>
            <ul class="space-y-2">
              {stall.hits.map((hit) => (
                <li class="flex items-start gap-2 text-sm text-ink-muted">
                  <span class="i-ph-check text-jade-500/70 shrink-0 mt-0.5 text-xs" />
                  <span>{hit}</span>
                </li>
              ))}
            </ul>
          </div>
        )}

        {stall.misses.length > 0 && (
          <div class="rounded-xl border border-flame-500/20 bg-flame-500/5 p-5">
            <div class="flex items-center gap-2 mb-3">
              <span class="i-ph-thumbs-down text-flame-400" />
              <h3 class="text-sm font-semibold text-flame-400">Misses</h3>
            </div>
            <ul class="space-y-2">
              {stall.misses.map((miss) => (
                <li class="flex items-start gap-2 text-sm text-ink-muted">
                  <span class="i-ph-x text-flame-500/70 shrink-0 mt-0.5 text-xs" />
                  <span>{miss}</span>
                </li>
              ))}
            </ul>
          </div>
        )}
      </div>

      {normalizedOriginalRating !== normalizedRating && (
        <div class="rounded-xl border border-warm-800/50 bg-surface-card p-4 mt-4">
          <p class="text-xs text-ink-faint">
            <span class="font-medium text-ink-muted">Rating at time of shoot:</span> {normalizedOriginalRating !== null ? `${normalizedOriginalRating}/3` : 'Unrated'}
            <span class="mx-2 text-ink-faint/50">&rarr;</span>
            <span class="font-medium text-ink-muted">Moderated:</span> {normalizedRating !== null ? `${normalizedRating}/3` : 'Unrated'}
          </p>
        </div>
      )}

      <!-- Google Maps Embed -->
      <div class="mt-8">
        <div class="flex items-center gap-2 mb-3">
          <span class="i-ph-map-pin-fill text-flame-400" />
          <h3 class="font-display font-700 text-sm">Location</h3>
        </div>
        <div class="rounded-xl overflow-hidden border border-warm-800/50">
          <iframe
            src={mapsSearchEmbedUrl}
            width="100%"
            style="border:0"
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade"
            title={`Map showing ${stall.name}`}
            class="w-full h-48 sm:h-64 md:h-80"
          ></iframe>
        </div>
        <div class="mt-2">
          <Button variant="outline" href={mapsUrl} target="_blank" rel="noopener" class="w-full sm:w-auto">
            <span class="i-ph-arrow-square-out text-xs" />
            Open in Google Maps
          </Button>
        </div>
      </div>

      <!-- YouTube Embed -->
      {hasYouTubeSection && (
        <div class="mt-8">
          <div class="flex items-center gap-2 mb-3">
            <span class="i-ph-youtube-logo-fill text-flame-400" />
            <h3 class="font-display font-700 text-sm">Video Review</h3>
          </div>
          {youtubeEmbedUrl ? (
            <div class="rounded-xl overflow-hidden border border-warm-800/50 aspect-video bg-surface-card">
              <iframe
                src={`${youtubeEmbedUrl}?rel=0`}
                width="100%"
                style="border:0"
                loading="lazy"
                title={`YouTube review for ${stall.name}`}
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
                class="w-full h-full"
              ></iframe>
            </div>
          ) : (
            <div class="rounded-xl overflow-hidden border border-warm-800/50 aspect-video bg-surface-card flex items-center justify-center p-6">
              <div class="text-center max-w-sm">
                <span class="i-ph-youtube-logo text-2xl text-ink-faint" />
                <p class="text-ink-muted text-sm mt-2">In-app preview unavailable for this stall.</p>
                <p class="text-ink-faint text-xs mt-1">Use the button below to open the video search.</p>
              </div>
            </div>
          )}
          {stall.youtubeTitle && <p class="text-ink-faint text-xs mt-2 italic">{stall.youtubeTitle}</p>}
          <div class="mt-2">
            <Button variant="outline" href={youtubeUrl} target="_blank" rel="noopener" class="w-full sm:w-auto">
              <span class="i-ph-arrow-square-out text-xs" />
              Open on YouTube
            </Button>
          </div>
        </div>
      )}
    </main>

    <footer class="border-t border-warm-800/40 py-6 mt-8 text-center">
      <a href="/" class="inline-block text-ink-faint text-xs hover:text-flame-400 transition-colors py-3">
        &larr; Back to all stalls
      </a>
    </footer>
  </div>
</Layout>

<script>
  import { markVisited, isFavorite, toggleFavorite } from '../../scripts/preferences';

  // Mark stall as visited
  const favBtn = document.getElementById('detail-fav-btn') as HTMLButtonElement;
  const slug = favBtn?.dataset.slug;
  if (slug) {
    markVisited(slug);

    // Initialize favorite state
    const outline = document.getElementById('detail-fav-outline');
    const filled = document.getElementById('detail-fav-filled');
    const fav = isFavorite(slug);
    if (outline) outline.classList.toggle('hidden', fav);
    if (filled) filled.classList.toggle('hidden', !fav);

    favBtn.addEventListener('click', () => {
      const newState = toggleFavorite(slug);
      if (outline) outline.classList.toggle('hidden', newState);
      if (filled) filled.classList.toggle('hidden', !newState);
    });
  }
</script>
