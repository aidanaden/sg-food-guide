---
import Layout from '../../layouts/Layout.astro';
import StallCard from '../../components/StallCard.astro';
import FilterBar from '../../components/FilterBar.astro';
import RoutePlanner from '../../components/RoutePlanner.astro';
import Badge from '../../components/ui/Badge.astro';
import { getCuisines, getStallsByCuisine, getAreas, getCountries } from '../../data/stalls';

export function getStaticPaths() {
  const cuisines = getCuisines();
  return cuisines.map((c) => ({
    params: { cuisine: c.id },
    props: { cuisineId: c.id, cuisineLabel: c.label },
  }));
}

const { cuisineId, cuisineLabel } = Astro.props;
const cuisineStalls = getStallsByCuisine(cuisineId);
const areas = getAreas(cuisineStalls);
const timeCategories = [...new Set(cuisineStalls.flatMap((s) => s.timeCategories))];
const countries = getCountries(cuisineStalls);
const mustTryCount = cuisineStalls.filter((s) => s.ratingModerated === 3).length;
const awardCount = cuisineStalls.filter((s) => s.awards.length > 0).length;
---

<Layout title={`Best ${cuisineLabel} in Singapore â€” SG Food Guide`} description={`${cuisineStalls.length} ${cuisineLabel} stalls reviewed and ranked.${mustTryCount > 0 ? ` ${mustTryCount} must-try rated stalls.` : ''}`} canonicalPath={`/cuisine/${cuisineId}`}>
  <!-- Hero -->
  <header class="relative overflow-hidden border-b border-warm-800">
    <div class="absolute inset-0 bg-gradient-to-br from-warm-950 via-surface to-warm-900 opacity-80"></div>
    <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top_right,_var(--color-flame-600)_0%,_transparent_50%)] opacity-15"></div>
    <div class="relative mx-auto max-w-6xl px-4 py-12 sm:py-16">
      <!-- Breadcrumb -->
      <a href="/" class="inline-flex items-center gap-1.5 text-sm text-ink-faint hover:text-flame-400 transition-colors mb-6 group py-2">
        <span class="i-ph-arrow-left text-sm group-hover:-translate-x-0.5 transition-transform" />
        All cuisines
      </a>

      <div class="flex items-start gap-3">
        <span class="i-ph-bowl-food-fill text-flame-400 text-3xl mt-1 shrink-0"></span>
        <div>
          <h1 class="font-display text-3xl sm:text-4xl lg:text-5xl font-800 tracking-tight">
            Best <span class="text-flame-400">{cuisineLabel}</span> in Singapore
          </h1>
          <p class="text-ink-muted text-base sm:text-lg mt-2 max-w-xl leading-relaxed">
            {cuisineStalls.length} stalls reviewed and ranked.
          </p>
        </div>
      </div>

      <!-- Stats -->
      <div class="flex flex-wrap gap-6 mt-6 text-sm">
        <div class="flex items-center gap-2">
          <span class="i-ph-fork-knife text-warm-400" />
          <span class="text-ink-muted"><strong class="text-ink font-semibold">{cuisineStalls.length}</strong> stalls</span>
        </div>
        {awardCount > 0 && (
          <div class="flex items-center gap-2">
            <span class="i-ph-trophy-fill text-gold-400" />
            <span class="text-ink-muted"><strong class="text-ink font-semibold">{awardCount}</strong> award winners</span>
          </div>
        )}
        {mustTryCount > 0 && (
          <div class="flex items-center gap-2">
            <span class="i-ph-star-fill text-jade-400" />
            <span class="text-ink-muted"><strong class="text-ink font-semibold">{mustTryCount}</strong> must-try</span>
          </div>
        )}
      </div>

      <div class="mt-6">
        <RoutePlanner />
      </div>
    </div>
  </header>

  <!-- Filter Bar -->
  <FilterBar
    areas={areas}
    timeCategories={timeCategories}
    countries={countries}
    totalCount={cuisineStalls.length}
    showCountryFilter={countries.length > 1}
    defaultCountry={countries.length > 1 ? 'SG' : ''}
  />

  <!-- Stall Grid -->
  <main class="mx-auto max-w-6xl px-4 py-8">
    <div id="stall-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
      {cuisineStalls.map((stall) => (
        <StallCard stall={stall} />
      ))}
    </div>

    <div id="empty-state" class="hidden text-center py-8 sm:py-16">
      <span class="i-ph-magnifying-glass text-5xl text-ink-faint"></span>
      <p class="text-ink-muted mt-4 text-lg font-display">No stalls match your filters</p>
      <p class="text-ink-faint text-sm mt-1">Try adjusting your search or filters</p>
      <button id="clear-filters" class="mt-4 rounded-lg bg-flame-500/20 text-flame-400 px-4 py-3 text-sm font-medium hover:bg-flame-500/30 transition-colors cursor-pointer min-h-[44px]">
        Clear all filters
      </button>
    </div>
  </main>

  <footer class="border-t border-warm-800/40 py-8 text-center">
    <a href="/" class="inline-block text-ink-faint text-xs hover:text-flame-400 transition-colors py-3">
      &larr; Back to all cuisines
    </a>
  </footer>
</Layout>

<script>
  import { initFilterSort } from '../../scripts/filter-sort';
  initFilterSort();
</script>
