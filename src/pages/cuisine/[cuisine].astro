---
import Layout from '../../layouts/Layout.astro';
import StallCard from '../../components/StallCard.astro';
import FilterBar from '../../components/FilterBar.astro';
import RoutePlanner from '../../components/RoutePlanner.astro';
import Badge from '../../components/ui/Badge.astro';
import { stalls, getCuisines, getStallsByCuisine, getAreas, getAllTimeCategories, getRatingLabel, getCountries } from '../../data/stalls';

export function getStaticPaths() {
  const cuisines = getCuisines();
  return cuisines.map((c) => ({
    params: { cuisine: c.id },
    props: { cuisineId: c.id, cuisineLabel: c.label },
  }));
}

const { cuisineId, cuisineLabel } = Astro.props;
const cuisineStalls = getStallsByCuisine(cuisineId);
const areas = getAreas(cuisineStalls);
const timeCategories = [...new Set(cuisineStalls.flatMap((s) => s.timeCategories))];
const countries = getCountries(cuisineStalls);
const mustTryCount = cuisineStalls.filter((s) => s.ratingModerated === 3).length;
const awardCount = cuisineStalls.filter((s) => s.awards.length > 0).length;
---

<Layout title={`Best ${cuisineLabel} in Singapore â€” SG Food Guide`} description={`${cuisineStalls.length} ${cuisineLabel} stalls reviewed and ranked in Singapore.`}>
  <!-- Hero -->
  <header class="relative overflow-hidden border-b border-warm-800">
    <div class="absolute inset-0 bg-gradient-to-br from-warm-950 via-surface to-warm-900 opacity-80"></div>
    <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top_right,_var(--color-flame-600)_0%,_transparent_50%)] opacity-15"></div>
    <div class="relative mx-auto max-w-6xl px-4 py-12 sm:py-16">
      <!-- Breadcrumb -->
      <a href="/" class="inline-flex items-center gap-1.5 text-sm text-ink-faint hover:text-flame-400 transition-colors mb-6 group">
        <span class="i-ph-arrow-left text-sm group-hover:-translate-x-0.5 transition-transform" />
        All cuisines
      </a>

      <div class="flex items-start gap-3">
        <span class="i-ph-bowl-food-fill text-flame-400 text-3xl mt-1 shrink-0"></span>
        <div>
          <h1 class="font-display text-3xl sm:text-4xl lg:text-5xl font-800 tracking-tight">
            Best <span class="text-flame-400">{cuisineLabel}</span> in Singapore
          </h1>
          <p class="text-ink-muted text-base sm:text-lg mt-2 max-w-xl leading-relaxed">
            {cuisineStalls.length} stalls reviewed and ranked.
          </p>
        </div>
      </div>

      <!-- Stats -->
      <div class="flex flex-wrap gap-6 mt-6 text-sm">
        <div class="flex items-center gap-2">
          <span class="i-ph-fork-knife text-warm-400" />
          <span class="text-ink-muted"><strong class="text-ink font-semibold">{cuisineStalls.length}</strong> stalls</span>
        </div>
        {awardCount > 0 && (
          <div class="flex items-center gap-2">
            <span class="i-ph-trophy-fill text-gold-400" />
            <span class="text-ink-muted"><strong class="text-ink font-semibold">{awardCount}</strong> award winners</span>
          </div>
        )}
        {mustTryCount > 0 && (
          <div class="flex items-center gap-2">
            <span class="i-ph-star-fill text-jade-400" />
            <span class="text-ink-muted"><strong class="text-ink font-semibold">{mustTryCount}</strong> must-try</span>
          </div>
        )}
      </div>

      <div class="mt-6">
        <RoutePlanner />
      </div>
    </div>
  </header>

  <!-- Filter Bar -->
  <FilterBar
    areas={areas}
    timeCategories={timeCategories}
    countries={countries}
    totalCount={cuisineStalls.length}
    showCountryFilter={countries.length > 1}
    defaultCountry={countries.length > 1 ? 'SG' : ''}
  />

  <!-- Stall Grid -->
  <main class="mx-auto max-w-6xl px-4 py-8">
    <div id="stall-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
      {cuisineStalls.map((stall) => (
        <StallCard stall={stall} />
      ))}
    </div>

    <div id="empty-state" class="hidden text-center py-16">
      <span class="i-ph-magnifying-glass text-5xl text-ink-faint"></span>
      <p class="text-ink-muted mt-4 text-lg font-display">No stalls match your filters</p>
      <p class="text-ink-faint text-sm mt-1">Try adjusting your search or filters</p>
      <button id="clear-filters" class="mt-4 rounded-lg bg-flame-500/20 text-flame-400 px-4 py-2 text-sm font-medium hover:bg-flame-500/30 transition-colors cursor-pointer">
        Clear all filters
      </button>
    </div>
  </main>

  <footer class="border-t border-warm-800/40 py-8 text-center">
    <a href="/" class="text-ink-faint text-xs hover:text-flame-400 transition-colors">
      &larr; Back to all cuisines
    </a>
  </footer>
</Layout>

<script>
  const searchInput = document.getElementById('search') as HTMLInputElement;
  const ratingFilter = document.getElementById('filter-rating') as HTMLSelectElement;
  const areaFilter = document.getElementById('filter-area') as HTMLSelectElement;
  const timeFilter = document.getElementById('filter-time') as HTMLSelectElement;
  const countryFilter = document.getElementById('filter-country') as HTMLSelectElement | null;
  const sortBy = document.getElementById('sort-by') as HTMLSelectElement;
  const grid = document.getElementById('stall-grid') as HTMLElement;
  const resultCount = document.getElementById('result-count') as HTMLElement;
  const emptyState = document.getElementById('empty-state') as HTMLElement;
  const activeFiltersContainer = document.getElementById('active-filters') as HTMLElement;
  const clearFiltersBtn = document.getElementById('clear-filters') as HTMLButtonElement;

  // Apply default country filter on load
  if (countryFilter) {
    const defaultCountry = countryFilter.dataset.default || '';
    if (defaultCountry) countryFilter.value = defaultCountry;
  }

  function getCards(): HTMLElement[] {
    return Array.from(grid.querySelectorAll('.stall-card')) as HTMLElement[];
  }

  function applyFilters() {
    const query = searchInput.value.toLowerCase().trim();
    const rating = ratingFilter.value;
    const area = areaFilter.value;
    const time = timeFilter.value;
    const country = countryFilter?.value || '';
    const cards = getCards();
    let visible = 0;

    cards.forEach((card) => {
      const el = card.closest('[data-name]') as HTMLElement || card;
      const name = el.dataset.name || '';
      const dish = el.dataset.dish || '';
      const address = el.dataset.address || '';
      const r = el.dataset.rating || '';
      const a = el.dataset.area || '';
      const t = el.dataset.time || '';
      const c = el.dataset.country || '';

      const show =
        (!query || name.includes(query) || dish.includes(query) || address.includes(query)) &&
        (!rating || r === rating) &&
        (!area || a === area) &&
        (!time || t.split(',').includes(time)) &&
        (!country || c === country);

      (card.closest('.stall-card') as HTMLElement || card).style.display = show ? '' : 'none';
      if (show) visible++;
    });

    resultCount.textContent = `Showing ${visible} of ${cards.length} stalls`;
    emptyState.classList.toggle('hidden', visible > 0);
    grid.classList.toggle('hidden', visible === 0);

    const chips: string[] = [];
    if (query) chips.push(`Search: "${query}"`);
    if (rating) chips.push(`Rating: ${rating === 'unrated' ? 'Unrated' : rating + '/3'}`);
    if (area) chips.push(`Area: ${area}`);
    if (time) chips.push(`Hours: ${time}`);
    if (country) chips.push(`Country: ${country}`);

    if (chips.length) {
      activeFiltersContainer.classList.remove('hidden');
      activeFiltersContainer.classList.add('flex');
      activeFiltersContainer.innerHTML = chips
        .map((c) => `<span class="inline-flex items-center gap-1 rounded-full bg-warm-800/60 px-2.5 py-0.5 text-xs text-ink-muted">${c}</span>`)
        .join('');
    } else {
      activeFiltersContainer.classList.add('hidden');
      activeFiltersContainer.classList.remove('flex');
    }
  }

  function applySorting() {
    const cards = getCards();
    cards.sort((a, b) => {
      const el = (c: HTMLElement) => c.closest('[data-rating]') as HTMLElement || c;
      const ratingA = el(a).dataset.rating || '0';
      const ratingB = el(b).dataset.rating || '0';
      const aR = ratingA === 'unrated' ? -1 : Number(ratingA);
      const bR = ratingB === 'unrated' ? -1 : Number(ratingB);
      const aP = Number(el(a).dataset.price); const bP = Number(el(b).dataset.price);
      const aE = Number(el(a).dataset.episode); const bE = Number(el(b).dataset.episode);
      const aA = el(a).dataset.awards === 'true' ? 1 : 0;
      const bA = el(b).dataset.awards === 'true' ? 1 : 0;
      switch (sortBy.value) {
        case 'rating-desc': return bR - aR || bA - aA;
        case 'rating-asc': return aR - bR;
        case 'price-asc': return aP - bP;
        case 'price-desc': return bP - aP;
        case 'episode-asc': return aE - bE;
        default: return 0;
      }
    });
    cards.forEach((c) => { const w = c.closest('.stall-card') as HTMLElement || c; grid.appendChild(w); });
  }

  function clearFilters() {
    searchInput.value = ''; ratingFilter.value = ''; areaFilter.value = ''; timeFilter.value = '';
    if (countryFilter) countryFilter.value = '';
    sortBy.value = 'rating-desc'; applyFilters(); applySorting();
  }

  searchInput.addEventListener('input', applyFilters);
  ratingFilter.addEventListener('change', () => { applyFilters(); applySorting(); });
  areaFilter.addEventListener('change', applyFilters);
  timeFilter.addEventListener('change', applyFilters);
  countryFilter?.addEventListener('change', applyFilters);
  sortBy.addEventListener('change', applySorting);
  clearFiltersBtn.addEventListener('click', clearFilters);

  // Apply initial filters (respects default country)
  applyFilters();
  applySorting();
</script>
