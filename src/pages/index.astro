---
import Layout from '../layouts/Layout.astro';
import StallCard from '../components/StallCard.astro';
import FilterBar from '../components/FilterBar.astro';
import RoutePlanner from '../components/RoutePlanner.astro';
import Button from '../components/ui/Button.astro';
import Badge from '../components/ui/Badge.astro';
import { stalls, getAreas, getAllTimeCategories, getCuisines, getCountries } from '../data/stalls';

const areas = getAreas();
const timeCategories = getAllTimeCategories();
const cuisines = getCuisines();
const countries = getCountries();
---

<Layout title="SG Food Guide — Best Hawker Food in Singapore" description={`The definitive guide to Singapore's best hawker food — ${stalls.length} stalls ranked, mapped, and reviewed across ${cuisines.length} cuisines.`} canonicalPath="/">
  <!-- Hero -->
  <header class="relative overflow-hidden border-b border-warm-800">
    <div class="absolute inset-0 bg-gradient-to-br from-warm-950 via-surface to-warm-900 opacity-80"></div>
    <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top_right,_var(--color-flame-600)_0%,_transparent_50%)] opacity-15"></div>
    <div class="relative mx-auto max-w-6xl px-4 py-16 sm:py-20">
      <div class="flex items-start gap-3 mb-4">
        <span class="i-ph-bowl-food-fill text-flame-400 text-3xl sm:text-4xl mt-1 shrink-0"></span>
        <div>
          <h1 class="font-display text-4xl sm:text-5xl lg:text-6xl font-800 tracking-tight">
            <span class="text-flame-400">SG</span> Food Guide
          </h1>
          <p class="text-ink-muted text-lg sm:text-xl mt-2 max-w-xl leading-relaxed">
            The definitive ranking of Singapore's best hawker food. {stalls.length} stalls reviewed and ranked.
          </p>
        </div>
      </div>

      <!-- Stats -->
      <div class="flex flex-wrap gap-6 mt-8 text-sm">
        <div class="flex items-center gap-2">
          <span class="i-ph-fork-knife text-warm-400"></span>
          <span class="text-ink-muted"><strong class="text-ink font-semibold">{stalls.length}</strong> stalls</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="i-ph-trophy-fill text-gold-400"></span>
          <span class="text-ink-muted"><strong class="text-ink font-semibold">{stalls.filter(s => s.awards.length > 0).length}</strong> award winners</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="i-ph-star-fill text-jade-400"></span>
          <span class="text-ink-muted"><strong class="text-ink font-semibold">{stalls.filter(s => s.ratingModerated === 3).length}</strong> must-try</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="i-ph-currency-dollar text-warm-400"></span>
          <span class="text-ink-muted">$4–$10 range</span>
        </div>
      </div>

      <!-- Cuisine links -->
      <div class="flex flex-wrap gap-2 mt-6">
        {cuisines.map((c) => (
          <a href={`/cuisine/${c.id}`}>
            <Badge variant="cuisine" size="md">
              <span class="i-ph-bowl-food text-xs" />
              {c.label}
              <span class="text-flame-400/50 ml-0.5">{c.count}</span>
            </Badge>
          </a>
        ))}
      </div>

      <!-- Route planner toggle -->
      <div class="mt-6">
        <RoutePlanner />
      </div>
    </div>
  </header>

  <!-- Filter Bar -->
  <FilterBar
    areas={areas}
    timeCategories={timeCategories}
    cuisines={cuisines}
    countries={countries}
    totalCount={stalls.length}
    showCuisineFilter={cuisines.length > 1}
    showCountryFilter={countries.length > 1}
    defaultCountry="SG"
  />

  <!-- Stall Grid -->
  <main class="mx-auto max-w-6xl px-4 py-8">
    <div id="stall-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
      {stalls.map((stall) => (
        <StallCard stall={stall} showCuisine={cuisines.length > 1} />
      ))}
    </div>

    <!-- Empty state -->
    <div id="empty-state" class="hidden text-center py-8 sm:py-16">
      <span class="i-ph-magnifying-glass text-5xl text-ink-faint"></span>
      <p class="text-ink-muted mt-4 text-lg font-display">No stalls match your filters</p>
      <p class="text-ink-faint text-sm mt-1">Try adjusting your search or filters</p>
      <button id="clear-filters" class="mt-4 rounded-lg bg-flame-500/20 text-flame-400 px-4 py-3 text-sm font-medium hover:bg-flame-500/30 transition-colors cursor-pointer min-h-[44px]">
        Clear all filters
      </button>
    </div>
  </main>

  <!-- Footer -->
  <footer class="border-t border-warm-800/40 py-8 text-center">
    <p class="text-ink-faint text-xs">
      Data sourced from
      <a
        href="https://docs.google.com/spreadsheets/d/1UMOZE2SM3_y5oUHafwJFEB9RrPDMqBbWjWnMGkO4gGg/edit?gid=1935025317"
        target="_blank"
        rel="noopener"
        class="text-flame-400/70 hover:text-flame-400 underline underline-offset-2 inline-block py-1"
      >
        SG Food Guide
      </a>
      spreadsheet.
    </p>
  </footer>
</Layout>

<script>
  import { fuzzyMatch, highlightText } from '../scripts/search';

  const searchInput = document.getElementById('search') as HTMLInputElement;
  const ratingFilter = document.getElementById('filter-rating') as HTMLSelectElement;
  const areaFilter = document.getElementById('filter-area') as HTMLSelectElement;
  const timeFilter = document.getElementById('filter-time') as HTMLSelectElement;
  const cuisineFilter = document.getElementById('filter-cuisine') as HTMLSelectElement | null;
  const countryFilter = document.getElementById('filter-country') as HTMLSelectElement | null;
  const favoritesFilter = document.getElementById('filter-favorites') as HTMLInputElement;
  const hideVisitedFilter = document.getElementById('filter-hide-visited') as HTMLInputElement;
  const sortBy = document.getElementById('sort-by') as HTMLSelectElement;
  const grid = document.getElementById('stall-grid') as HTMLElement;
  const resultCount = document.getElementById('result-count') as HTMLElement;
  const emptyState = document.getElementById('empty-state') as HTMLElement;
  const activeFiltersContainer = document.getElementById('active-filters') as HTMLElement;
  const clearFiltersBtn = document.getElementById('clear-filters') as HTMLButtonElement;

  // Cache original text for search highlighting restoration
  interface CardCache {
    el: HTMLElement;
    nameEl: HTMLElement | null;
    dishEl: HTMLElement | null;
    nameText: string;
    dishText: string;
  }
  const cardCache: CardCache[] = [];

  // Apply default country filter on load
  if (countryFilter) {
    const defaultCountry = countryFilter.dataset.default || '';
    if (defaultCountry) countryFilter.value = defaultCountry;
  }

  function getCards(): HTMLElement[] {
    return Array.from(grid.querySelectorAll('.stall-card')) as HTMLElement[];
  }

  function buildCache() {
    cardCache.length = 0;
    getCards().forEach((card) => {
      const el = card.closest('[data-name]') as HTMLElement || card;
      const nameEl = el.querySelector('h2');
      const dishEl = el.querySelector('p.text-ink-faint.text-xs') as HTMLElement | null;
      cardCache.push({
        el,
        nameEl,
        dishEl,
        nameText: nameEl?.textContent || '',
        dishText: dishEl?.textContent || '',
      });
    });
  }

  function applyFilters() {
    const query = searchInput.value.toLowerCase().trim();
    const rating = ratingFilter.value;
    const area = areaFilter.value;
    const time = timeFilter.value;
    const cuisine = cuisineFilter?.value || '';
    const country = countryFilter?.value || '';
    let visible = 0;

    const onlyFavs = favoritesFilter?.checked || false;
    const hideVisited = hideVisitedFilter?.checked || false;

    if (cardCache.length === 0) buildCache();

    cardCache.forEach(({ el, nameEl, dishEl, nameText, dishText }) => {
      const name = el.dataset.name || '';
      const dish = el.dataset.dish || '';
      const address = el.dataset.address || '';
      const cardRating = el.dataset.rating || '';
      const cardArea = el.dataset.area || '';
      const cardTime = el.dataset.time || '';
      const cardCuisine = el.dataset.cuisine || '';
      const cardCountry = el.dataset.country || '';
      const cardFav = el.dataset.fav === 'true';
      const cardVisited = el.dataset.visited === 'true';

      const matchesSearch = fuzzyMatch(query, [name, dish, address]);
      const matchesRating = !rating || cardRating === rating;
      const matchesArea = !area || cardArea === area;
      const matchesTime = !time || cardTime.split(',').includes(time);
      const matchesCuisine = !cuisine || cardCuisine === cuisine;
      const matchesCountry = !country || cardCountry === country;
      const matchesFav = !onlyFavs || cardFav;
      const matchesVisited = !hideVisited || !cardVisited;

      const show = matchesSearch && matchesRating && matchesArea && matchesTime && matchesCuisine && matchesCountry && matchesFav && matchesVisited;
      (el.closest('.stall-card') as HTMLElement || el).style.display = show ? '' : 'none';
      if (show) visible++;

      // Apply search highlighting
      if (nameEl) nameEl.innerHTML = highlightText(nameText, query);
      if (dishEl) dishEl.innerHTML = highlightText(dishText, query);
    });

    resultCount.textContent = `Showing ${visible} of ${cardCache.length} stalls`;
    emptyState.classList.toggle('hidden', visible > 0);
    grid.classList.toggle('hidden', visible === 0);

    // Active filter chips
    const chips: string[] = [];
    if (query) chips.push(`Search: "${query}"`);
    if (rating) chips.push(`Rating: ${rating === 'unrated' ? 'Unrated' : rating + '/3'}`);
    if (area) chips.push(`Area: ${area}`);
    if (time) chips.push(`Hours: ${time}`);
    if (cuisine) chips.push(`Cuisine: ${cuisine}`);
    if (country) chips.push(`Country: ${country}`);

    if (chips.length) {
      activeFiltersContainer.classList.remove('hidden');
      activeFiltersContainer.classList.add('flex');
      activeFiltersContainer.innerHTML = chips
        .map((c) => `<span class="inline-flex items-center gap-1 rounded-full bg-warm-800/60 px-2.5 py-1 text-xs text-ink-muted">${c}</span>`)
        .join('');
    } else {
      activeFiltersContainer.classList.add('hidden');
      activeFiltersContainer.classList.remove('flex');
    }
  }

  function applySorting() {
    const cards = getCards();
    const sort = sortBy.value;

    cards.sort((a, b) => {
      const el = (c: HTMLElement) => c.closest('[data-rating]') as HTMLElement || c;
      const ratingA = el(a).dataset.rating || '0';
      const ratingB = el(b).dataset.rating || '0';
      const aR = ratingA === 'unrated' ? -1 : Number(ratingA);
      const bR = ratingB === 'unrated' ? -1 : Number(ratingB);
      const aP = Number(el(a).dataset.price); const bP = Number(el(b).dataset.price);
      const aE = Number(el(a).dataset.episode); const bE = Number(el(b).dataset.episode);
      const aA = el(a).dataset.awards === 'true' ? 1 : 0;
      const bA = el(b).dataset.awards === 'true' ? 1 : 0;

      switch (sort) {
        case 'rating-desc': return bR - aR || bA - aA;
        case 'rating-asc': return aR - bR;
        case 'price-asc': return aP - bP;
        case 'price-desc': return bP - aP;
        case 'episode-asc': return aE - bE;
        default: return 0;
      }
    });

    cards.forEach((card) => {
      const wrapper = card.closest('.stall-card') as HTMLElement || card;
      grid.appendChild(wrapper);
    });
  }

  function clearFilters() {
    searchInput.value = '';
    ratingFilter.value = '';
    areaFilter.value = '';
    timeFilter.value = '';
    if (cuisineFilter) cuisineFilter.value = '';
    if (countryFilter) countryFilter.value = '';
    sortBy.value = 'rating-desc';
    applyFilters();
    applySorting();
  }

  searchInput.addEventListener('input', applyFilters);
  ratingFilter.addEventListener('change', () => { applyFilters(); applySorting(); });
  areaFilter.addEventListener('change', applyFilters);
  timeFilter.addEventListener('change', applyFilters);
  cuisineFilter?.addEventListener('change', applyFilters);
  countryFilter?.addEventListener('change', applyFilters);
  favoritesFilter?.addEventListener('change', applyFilters);
  hideVisitedFilter?.addEventListener('change', applyFilters);
  sortBy.addEventListener('change', applySorting);
  clearFiltersBtn.addEventListener('click', clearFilters);

  // Apply initial filters (respects default country)
  applyFilters();
  applySorting();
</script>
