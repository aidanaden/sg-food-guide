---
import Card from './ui/Card.astro';
import Badge from './ui/Badge.astro';
import { type Stall, getRatingLabel, getRatingVariant, getStallArea, countryLabels } from '../data/stalls';

interface Props {
  stall: Stall;
  showCuisine?: boolean;
  minimal?: boolean;
}

const { stall, showCuisine = false, minimal = false } = Astro.props;
const area = getStallArea(stall);
const ratingVariant = getRatingVariant(stall.ratingModerated);
const ratingLabel = getRatingLabel(stall.ratingModerated);
const displayRating = stall.ratingModerated === null ? null : Math.min(Math.max(stall.ratingModerated, 0), 3);
---

<Card
  variant="interactive"
  accent={ratingVariant}
  href={`/stall/${stall.slug}`}
  class="stall-card relative flex flex-col"
  data-slug={stall.slug}
  data-name={stall.name.toLowerCase()}
  data-dish={stall.dishName.toLowerCase()}
  data-address={stall.address.toLowerCase()}
  data-area={area}
  data-cuisine={stall.cuisine}
  data-rating={displayRating ?? 'unrated'}
  data-country={stall.country}
  data-price={stall.price}
  data-episode={stall.episodeNumber || 99}
  data-awards={stall.awards.length > 0 ? 'true' : 'false'}
  data-time={stall.timeCategories.join(',')}
  data-lat={stall.lat}
  data-lng={stall.lng}
>
  <Fragment slot="banner">
    {!minimal && stall.awards.length > 0 && (
      <div class="bg-gradient-to-r from-gold-600/20 to-gold-500/10 border-b border-gold-500/20 px-4 py-1.5 flex items-center gap-1.5">
        <span class="i-ph-trophy-fill text-gold-400 text-xs" />
        <span class="text-gold-400 text-xs font-semibold tracking-wide uppercase">
          {stall.awards[0]}
        </span>
      </div>
    )}
  </Fragment>

  <Fragment slot="header">
    <div class="flex items-start justify-between gap-3 mb-3">
      <div class="min-w-0 flex-1">
        <h2 class="font-display font-700 text-base leading-snug group-hover:text-flame-400 transition-colors line-clamp-2">
          {stall.name}
        </h2>
        <div class="flex items-center gap-2 mt-0.5">
          <p class="text-ink-faint text-xs">{stall.dishName}</p>
          {showCuisine && !minimal && (
            <Badge variant="cuisine" size="sm" class="text-xs py-0">
              {stall.cuisineLabel}
            </Badge>
          )}
        </div>
      </div>
      <div class="shrink-0 flex items-start gap-1.5 pt-0.5">
        <button
          type="button"
          data-fav-btn={stall.slug}
          class="fav-btn inline-flex h-8 w-8 items-center justify-center rounded-md border border-transparent transition-colors text-ink-faint hover:text-flame-400 hover:border-warm-700/50 self-start"
          aria-label="Toggle favorite"
        >
          <span class="fav-icon-outline i-ph-heart text-sm" />
          <span class="fav-icon-filled i-ph-heart-fill text-sm text-flame-400 hidden" />
        </button>
        <Badge variant={ratingVariant} size="xs" class="min-w-[2.5rem] shrink-0 justify-center font-mono font-semibold gap-1 self-start">
          {displayRating !== null ? (
            <Fragment>
              <span class={ratingVariant === 'rating-3' ? 'i-ph-star-fill text-[0.625rem]' : ratingVariant === 'rating-2' ? 'i-ph-star-half-fill text-[0.625rem]' : ratingVariant === 'rating-1' ? 'i-ph-star text-[0.625rem]' : 'i-ph-minus text-[0.625rem]'} />
              {`${displayRating}/3`}
            </Fragment>
          ) : '—'}
        </Badge>
      </div>
    </div>
  </Fragment>

  {minimal ? (
    <div class="text-sm text-ink-muted flex-1">
      <p class="text-xs leading-snug truncate">
        {area}{area && stall.openingTimes ? ' • ' : ''}{stall.openingTimes}
      </p>
    </div>
  ) : (
    <div class="space-y-1.5 text-sm text-ink-muted flex-1">
      <div class="flex items-start gap-2">
        <span class="i-ph-map-pin text-ink-faint shrink-0 mt-0.5 text-xs" />
        <span class="text-xs leading-snug line-clamp-2">{stall.address}</span>
      </div>
      <div class="flex items-center gap-2">
        <span class="i-ph-clock text-ink-faint shrink-0 text-xs" />
        <span class="text-xs truncate">{stall.openingTimes}</span>
      </div>
    </div>
  )}

  <Fragment slot="footer">
    <div class:list={[
      'flex items-center justify-between border-t border-warm-800/40',
      minimal ? 'mt-3 pt-2' : 'mt-4 pt-3',
    ]}>
      <div class="flex items-center gap-2">
        <span class="font-mono font-semibold text-flame-400">${stall.price.toFixed(stall.price % 1 ? 2 : 0)}</span>
        {!minimal && stall.country !== 'SG' && (
          <span class="text-xs text-ink-faint bg-warm-800/50 rounded px-1.5 py-0.5 font-medium">
            {countryLabels[stall.country]}
          </span>
        )}
      </div>
      <div class="flex items-center gap-3">
        {!minimal && (
          <span class={`text-xs font-medium ${ratingVariant === 'rating-0' ? 'text-ink-muted' : ratingVariant === 'rating-1' ? 'text-flame-400' : ratingVariant === 'rating-2' ? 'text-gold-400' : 'text-jade-400'}`}>
            {ratingLabel}
          </span>
        )}
        <span class="i-ph-arrow-right text-ink-faint text-sm group-hover:text-flame-400 group-hover:translate-x-0.5 transition-all" />
      </div>
    </div>

    {!minimal && stall.hits.length > 0 && (
      <div class="mt-2 flex items-start gap-1.5 text-xs text-ink-faint">
        <span class="i-ph-thumbs-up text-jade-500/60 shrink-0 mt-px" />
        <span class="line-clamp-1 italic">"{stall.hits[0]}"</span>
      </div>
    )}
  </Fragment>
</Card>

<script>
  import { isFavorite, toggleFavorite, getVisited } from '../scripts/preferences';

  // Initialize all favorite buttons once (Astro deduplicates this script)
  function initFavorites() {
    const visited = getVisited();

    document.querySelectorAll<HTMLButtonElement>('.fav-btn').forEach((btn) => {
      const slug = btn.dataset.favBtn;
      if (!slug) return;

      // Set initial state
      updateFavIcon(btn, isFavorite(slug));

      // Mark visited cards
      if (visited.has(slug)) {
        const card = btn.closest('.stall-card');
        card?.setAttribute('data-visited', 'true');
      }

      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const newState = toggleFavorite(slug);
        updateFavIcon(btn, newState);

        // Update data attribute for filtering
        const card = btn.closest('.stall-card');
        card?.setAttribute('data-fav', newState ? 'true' : 'false');
      });
    });
  }

  function updateFavIcon(btn: HTMLButtonElement, active: boolean) {
    const outline = btn.querySelector('.fav-icon-outline') as HTMLElement;
    const filled = btn.querySelector('.fav-icon-filled') as HTMLElement;
    if (outline) outline.classList.toggle('hidden', active);
    if (filled) filled.classList.toggle('hidden', !active);

    const card = btn.closest('.stall-card');
    card?.setAttribute('data-fav', active ? 'true' : 'false');
  }

  // Run on DOMContentLoaded and after Astro page transitions
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initFavorites);
  } else {
    initFavorites();
  }
</script>
