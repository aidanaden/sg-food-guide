---
/**
 * Route Planner â€” client-side only (Leaflet + vanilla JS).
 * Renders a toggleable panel with a Leaflet map, nearest-neighbor route optimizer,
 * transport mode selector, and Google Maps directions link.
 */
---

<!-- Toggle Button -->
<button
  id="route-toggle"
  type="button"
  class="inline-flex items-center gap-2 rounded-lg border border-warm-700/50 bg-surface-raised px-4 py-2.5 text-sm font-medium text-ink hover:border-flame-500/40 hover:text-flame-400 transition-colors cursor-pointer"
>
  <span class="i-ph-path text-base" />
  <span>Plan Route</span>
</button>

<!-- Toast notification for no-coords stalls -->
<div
  id="route-toast"
  class="fixed top-4 left-1/2 -translate-x-1/2 z-[60] hidden"
>
  <div class="flex items-center gap-2 rounded-lg border border-warm-700 bg-surface-overlay px-4 py-2.5 shadow-xl text-sm">
    <span class="i-ph-warning-circle text-gold-400" />
    <span id="route-toast-msg" class="text-ink-muted">This stall has no location data</span>
  </div>
</div>

<!-- Route Planner Panel (hidden by default) -->
<div
  id="route-panel"
  class="hidden fixed inset-x-0 bottom-0 z-50 bg-surface border-t border-warm-700 shadow-2xl max-h-[70vh] flex flex-col"
>
  <!-- Panel Header -->
  <div class="flex items-center justify-between px-4 py-3 border-b border-warm-800/60 shrink-0">
    <div class="flex items-center gap-2">
      <span class="i-ph-path text-flame-400" />
      <h3 class="font-display font-700 text-sm">Route Planner</h3>
      <span id="route-count" class="text-ink-faint text-xs">(0 selected)</span>
    </div>
    <div class="flex items-center gap-2">
      <!-- Transport mode selector -->
      <div id="transport-modes" class="flex items-center border border-warm-700/50 rounded-lg overflow-hidden">
        <button type="button" data-mode="walking" class="transport-btn active px-2.5 py-1.5 text-xs flex items-center gap-1 transition-colors cursor-pointer" title="Walking">
          <span class="i-ph-person-simple-walk text-sm" />
        </button>
        <button type="button" data-mode="transit" class="transport-btn px-2.5 py-1.5 text-xs flex items-center gap-1 border-l border-warm-700/50 transition-colors cursor-pointer" title="Public Transit">
          <span class="i-ph-train text-sm" />
        </button>
        <button type="button" data-mode="driving" class="transport-btn px-2.5 py-1.5 text-xs flex items-center gap-1 border-l border-warm-700/50 transition-colors cursor-pointer" title="Driving">
          <span class="i-ph-car text-sm" />
        </button>
      </div>
      <button id="route-clear" type="button" class="text-xs text-ink-faint hover:text-ink transition-colors cursor-pointer px-2 py-1">
        Clear
      </button>
      <button id="route-close" type="button" class="text-ink-faint hover:text-ink transition-colors cursor-pointer p-1">
        <span class="i-ph-x text-lg" />
      </button>
    </div>
  </div>

  <!-- Panel Body -->
  <div class="flex flex-col md:flex-row flex-1 overflow-hidden">
    <!-- Map -->
    <div id="route-map" class="w-full md:w-2/3 h-64 md:h-auto min-h-48"></div>

    <!-- Route List -->
    <div class="w-full md:w-1/3 overflow-y-auto p-4 border-t md:border-t-0 md:border-l border-warm-800/40">
      <div id="route-empty" class="text-center py-8">
        <span class="i-ph-map-pin-plus text-3xl text-ink-faint" />
        <p class="text-ink-muted text-sm mt-2">Click stall cards to add them to your route</p>
        <p class="text-ink-faint text-xs mt-1">Stalls without location data cannot be added</p>
      </div>
      <ol id="route-list" class="space-y-3 hidden"></ol>
      <div id="route-summary" class="hidden mt-4 pt-3 border-t border-warm-800/40 space-y-2">
        <div class="flex items-center justify-between text-sm">
          <span class="text-ink-muted">Total distance</span>
          <span id="route-distance" class="font-mono font-semibold text-flame-400">0 km</span>
        </div>
        <div class="flex items-center justify-between text-sm">
          <span class="text-ink-muted">Est. travel time</span>
          <span id="route-time" class="font-mono font-semibold text-ink">0 min</span>
        </div>
        <a
          id="route-gmaps-link"
          href="#"
          target="_blank"
          rel="noopener"
          class="hidden mt-2 w-full inline-flex items-center justify-center gap-2 rounded-lg border border-flame-500/30 bg-flame-500/10 px-3 py-2 text-sm font-medium text-flame-400 hover:bg-flame-500/20 transition-colors"
        >
          <span class="i-ph-navigation-arrow text-xs" />
          Open in Google Maps
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Leaflet CSS â€” only loaded when panel opens -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  .transport-btn {
    background: transparent;
    color: var(--color-ink-faint);
  }
  .transport-btn:hover {
    color: var(--color-ink-muted);
    background: var(--color-warm-800);
  }
  .transport-btn.active {
    background: var(--color-flame-400);
    color: white;
  }
</style>

<script>
  import L from 'leaflet';

  // â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  interface RouteStop {
    slug: string;
    name: string;
    lat: number;
    lng: number;
    rating: number;
    price: string;
  }

  type TransportMode = 'walking' | 'transit' | 'driving';

  // Average speeds in km/h for time estimation
  const SPEEDS: Record<TransportMode, number> = {
    walking: 5,
    transit: 25,
    driving: 35,
  };

  // Google Maps direction mode names
  const GMAPS_MODE: Record<TransportMode, string> = {
    walking: 'walking',
    transit: 'transit',
    driving: 'driving',
  };

  let selectedStops: RouteStop[] = [];
  let transportMode: TransportMode = 'walking';
  let map: L.Map | null = null;
  let markers: L.Marker[] = [];
  let routeLine: L.Polyline | null = null;
  let isOpen = false;
  let toastTimeout: ReturnType<typeof setTimeout> | null = null;

  // â”€â”€â”€ Elements â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const toggle = document.getElementById('route-toggle')!;
  const panel = document.getElementById('route-panel')!;
  const closeBtn = document.getElementById('route-close')!;
  const clearBtn = document.getElementById('route-clear')!;
  const countEl = document.getElementById('route-count')!;
  const listEl = document.getElementById('route-list')!;
  const emptyEl = document.getElementById('route-empty')!;
  const summaryEl = document.getElementById('route-summary')!;
  const distanceEl = document.getElementById('route-distance')!;
  const timeEl = document.getElementById('route-time')!;
  const gmapsLink = document.getElementById('route-gmaps-link') as HTMLAnchorElement;
  const mapContainer = document.getElementById('route-map')!;
  const toast = document.getElementById('route-toast')!;
  const toastMsg = document.getElementById('route-toast-msg')!;
  const transportBtns = document.querySelectorAll<HTMLButtonElement>('.transport-btn');

  // â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showToast(msg: string) {
    toastMsg.textContent = msg;
    toast.classList.remove('hidden');
    if (toastTimeout) clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => toast.classList.add('hidden'), 3000);
  }

  // â”€â”€â”€ Transport mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  transportBtns.forEach((btn) => {
    btn.addEventListener('click', () => {
      transportMode = btn.dataset.mode as TransportMode;
      transportBtns.forEach((b) => b.classList.remove('active'));
      btn.classList.add('active');
      renderRoute();
    });
  });

  // â”€â”€â”€ Custom marker icon â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function makeIcon(color: string, label: string): L.DivIcon {
    return L.divIcon({
      className: '',
      iconSize: [28, 28],
      iconAnchor: [14, 28],
      html: `<div style="
        width:28px;height:28px;border-radius:50% 50% 50% 0;
        background:${color};transform:rotate(-45deg);
        display:flex;align-items:center;justify-content:center;
        border:2px solid rgba(0,0,0,0.3);box-shadow:0 2px 6px rgba(0,0,0,0.3);
      "><span style="transform:rotate(45deg);font-size:11px;font-weight:700;color:white;">${label}</span></div>`,
    });
  }

  // â”€â”€â”€ Haversine distance (km) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function haversine(lat1: number, lon1: number, lat2: number, lon2: number): number {
    const R = 6371;
    const dLat = ((lat2 - lat1) * Math.PI) / 180;
    const dLon = ((lon2 - lon1) * Math.PI) / 180;
    const a =
      Math.sin(dLat / 2) ** 2 +
      Math.cos((lat1 * Math.PI) / 180) * Math.cos((lat2 * Math.PI) / 180) * Math.sin(dLon / 2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  // â”€â”€â”€ Time estimation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function estimateTime(distKm: number): string {
    const mins = Math.round((distKm / SPEEDS[transportMode]) * 60);
    if (mins < 60) return `${mins} min`;
    const hrs = Math.floor(mins / 60);
    const rem = mins % 60;
    return rem > 0 ? `${hrs}h ${rem}m` : `${hrs}h`;
  }

  // â”€â”€â”€ Google Maps directions URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildGmapsUrl(stops: RouteStop[]): string {
    if (stops.length < 2) return '#';
    const origin = `${stops[0].lat},${stops[0].lng}`;
    const dest = `${stops[stops.length - 1].lat},${stops[stops.length - 1].lng}`;
    const waypoints = stops.slice(1, -1).map((s) => `${s.lat},${s.lng}`).join('|');
    let url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${dest}&travelmode=${GMAPS_MODE[transportMode]}`;
    if (waypoints) url += `&waypoints=${waypoints}`;
    return url;
  }

  // â”€â”€â”€ Nearest neighbor route optimization â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function optimizeRoute(stops: RouteStop[]): RouteStop[] {
    if (stops.length <= 2) return [...stops];
    const remaining = [...stops];
    const route: RouteStop[] = [remaining.shift()!];
    while (remaining.length > 0) {
      const last = route[route.length - 1];
      let nearest = 0;
      let minDist = Infinity;
      for (let i = 0; i < remaining.length; i++) {
        const d = haversine(last.lat, last.lng, remaining[i].lat, remaining[i].lng);
        if (d < minDist) { minDist = d; nearest = i; }
      }
      route.push(remaining.splice(nearest, 1)[0]);
    }
    return route;
  }

  function totalDistance(stops: RouteStop[]): number {
    let d = 0;
    for (let i = 1; i < stops.length; i++) {
      d += haversine(stops[i - 1].lat, stops[i - 1].lng, stops[i].lat, stops[i].lng);
    }
    return d;
  }

  // â”€â”€â”€ Map init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function initMap() {
    if (map) return;
    map = L.map(mapContainer, { zoomControl: true }).setView([1.3521, 103.8198], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a>',
      maxZoom: 18,
    }).addTo(map);

    // Show all stalls as faded markers
    document.querySelectorAll<HTMLElement>('.stall-card').forEach((card) => {
      const lat = parseFloat(card.dataset.lat || '0');
      const lng = parseFloat(card.dataset.lng || '0');
      if (lat && lng) {
        L.circleMarker([lat, lng], {
          radius: 5, fillColor: '#7a6e62', fillOpacity: 0.4,
          stroke: false,
        }).addTo(map!);
      }
    });
  }

  // â”€â”€â”€ Render route on map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderRoute() {
    if (!map) return;

    // Clear previous
    markers.forEach((m) => map!.removeLayer(m));
    markers = [];
    if (routeLine) { map.removeLayer(routeLine); routeLine = null; }

    const optimized = optimizeRoute(selectedStops);
    const colors: Record<number, string> = { 1: '#ff6b35', 2: '#fbbf24', 3: '#4ade80' };

    // Add numbered markers
    optimized.forEach((stop, i) => {
      const color = colors[stop.rating] || '#7a6e62';
      const m = L.marker([stop.lat, stop.lng], {
        icon: makeIcon(color, String(i + 1)),
      }).addTo(map!).bindPopup(`<b>${i + 1}. ${stop.name}</b><br>$${stop.price}`);
      markers.push(m);
    });

    // Draw route line
    if (optimized.length >= 2) {
      const latlngs = optimized.map((s) => [s.lat, s.lng] as [number, number]);
      routeLine = L.polyline(latlngs, {
        color: '#ff6b35', weight: 3, opacity: 0.7, dashArray: '8 6',
      }).addTo(map);
    }

    // Fit bounds
    if (optimized.length > 0) {
      const group = L.featureGroup(markers);
      map.fitBounds(group.getBounds().pad(0.15));
    }

    // Update list
    renderList(optimized);
  }

  function renderList(optimized: RouteStop[]) {
    const hasStops = optimized.length > 0;
    emptyEl.classList.toggle('hidden', hasStops);
    listEl.classList.toggle('hidden', !hasStops);
    summaryEl.classList.toggle('hidden', !hasStops);
    countEl.textContent = `(${optimized.length} selected)`;

    if (!hasStops) {
      gmapsLink.classList.add('hidden');
      return;
    }

    const modeIcon = transportMode === 'walking' ? 'ðŸš¶' : transportMode === 'transit' ? 'ðŸš‡' : 'ðŸš—';

    listEl.innerHTML = optimized.map((stop, i) => {
      if (i === 0) {
        return `
          <li class="flex items-start gap-3">
            <span class="shrink-0 w-6 h-6 rounded-full bg-flame-500/20 text-flame-400 text-xs font-bold flex items-center justify-center mt-0.5">1</span>
            <div class="min-w-0 flex-1">
              <p class="text-sm font-medium text-ink truncate">${stop.name}</p>
              <p class="text-xs text-ink-faint">$${stop.price}</p>
            </div>
          </li>
        `;
      }
      const dist = haversine(optimized[i-1].lat, optimized[i-1].lng, stop.lat, stop.lng);
      const time = estimateTime(dist);
      return `
        <li>
          <div class="flex items-center gap-2 py-1 pl-2 text-ink-faint">
            <span class="w-px h-4 bg-warm-700 ml-2.5"></span>
            <span class="text-[10px] font-mono">${dist.toFixed(1)} km Â· ${time}</span>
          </div>
          <div class="flex items-start gap-3">
            <span class="shrink-0 w-6 h-6 rounded-full bg-flame-500/20 text-flame-400 text-xs font-bold flex items-center justify-center mt-0.5">${i + 1}</span>
            <div class="min-w-0 flex-1">
              <p class="text-sm font-medium text-ink truncate">${stop.name}</p>
              <p class="text-xs text-ink-faint">$${stop.price}</p>
            </div>
          </div>
        </li>
      `;
    }).join('');

    const dist = totalDistance(optimized);
    distanceEl.textContent = `${dist.toFixed(1)} km`;
    timeEl.textContent = estimateTime(dist);

    // Google Maps directions link
    if (optimized.length >= 2) {
      gmapsLink.href = buildGmapsUrl(optimized);
      gmapsLink.classList.remove('hidden');
    } else {
      gmapsLink.classList.add('hidden');
    }
  }

  // â”€â”€â”€ Toggle card selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toggleStall(card: HTMLElement) {
    const slug = card.closest('a')?.getAttribute('href')?.split('/').pop() || '';
    const name = card.dataset.name || '';
    const lat = parseFloat(card.dataset.lat || '0');
    const lng = parseFloat(card.dataset.lng || '0');
    const ratingStr = card.dataset.rating || '0';
    const rating = ratingStr === 'unrated' ? 0 : parseInt(ratingStr);
    const price = card.dataset.price || '0';

    // Show toast for stalls without valid coordinates
    if (!lat && !lng) {
      // Capitalize the name properly for display
      const displayName = card.querySelector('h2')?.textContent?.trim() || name;
      showToast(`${displayName || 'This stall'} has no location data and can't be added to the route`);
      return;
    }

    const idx = selectedStops.findIndex((s) => s.slug === slug);
    if (idx >= 0) {
      selectedStops.splice(idx, 1);
      card.classList.remove('ring-2', 'ring-flame-400/50');
    } else {
      selectedStops.push({ slug, name, lat, lng, rating, price });
      card.classList.add('ring-2', 'ring-flame-400/50');
    }
    renderRoute();
  }

  // â”€â”€â”€ Event handlers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  toggle.addEventListener('click', () => {
    isOpen = !isOpen;
    panel.classList.toggle('hidden', !isOpen);
    toggle.classList.toggle('border-flame-500/50', isOpen);
    toggle.classList.toggle('text-flame-400', isOpen);

    if (isOpen) {
      initMap();
      setTimeout(() => map?.invalidateSize(), 100);

      // In route mode, intercept card clicks
      document.querySelectorAll<HTMLElement>('.stall-card').forEach((card) => {
        card.addEventListener('click', routeClickHandler);
      });
    } else {
      document.querySelectorAll<HTMLElement>('.stall-card').forEach((card) => {
        card.removeEventListener('click', routeClickHandler);
        card.classList.remove('ring-2', 'ring-flame-400/50');
      });
    }
  });

  function routeClickHandler(e: Event) {
    if (!isOpen) return;
    e.preventDefault();
    e.stopPropagation();
    toggleStall(e.currentTarget as HTMLElement);
  }

  closeBtn.addEventListener('click', () => {
    isOpen = false;
    panel.classList.add('hidden');
    toggle.classList.remove('border-flame-500/50', 'text-flame-400');
    document.querySelectorAll<HTMLElement>('.stall-card').forEach((card) => {
      card.removeEventListener('click', routeClickHandler);
      card.classList.remove('ring-2', 'ring-flame-400/50');
    });
  });

  clearBtn.addEventListener('click', () => {
    selectedStops = [];
    document.querySelectorAll<HTMLElement>('.stall-card').forEach((card) => {
      card.classList.remove('ring-2', 'ring-flame-400/50');
    });
    renderRoute();
  });
</script>
